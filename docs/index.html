<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRADING BOT · TERMINAL</title>
  <style>
    :root {
      --bg:      #0d0d0d;
      --panel:   #141414;
      --border:  #2a2a2a;
      --amber:   #f0a500;
      --green:   #00e676;
      --red:     #ff4444;
      --muted:   #888888;
      --text:    #d4d4d4;
      --white:   #f0f0f0;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', Courier, monospace;
      min-height: 100vh;
      font-size: 13px;
    }

    /* ── Ticker Tape ── */
    .ticker-tape {
      background: #0a0a0a;
      border-bottom: 1px solid var(--amber);
      overflow: hidden;
      height: 28px;
      display: flex;
      align-items: center;
    }
    .ticker-tape-inner {
      display: flex;
      white-space: nowrap;
      animation: ticker-scroll 30s linear infinite;
    }
    .ticker-tape-inner span {
      display: inline-block;
      padding: 0 28px;
      color: var(--amber);
      font-size: 11px;
      letter-spacing: 0.05em;
    }
    .tape-up   { color: var(--green)  !important; }
    .tape-down { color: var(--red)    !important; }
    @keyframes ticker-scroll {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    /* ── Header Bar ── */
    .header-bar {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--amber);
      font-size: 13px;
      font-weight: bold;
      letter-spacing: 0.09em;
      white-space: nowrap;
    }
    .header-badges {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge {
      background: rgba(240,165,0,0.1);
      border: 1px solid rgba(240,165,0,0.3);
      color: var(--amber);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 2px;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }
    .badge-live {
      background: rgba(0,230,118,0.1);
      border: 1px solid rgba(0,230,118,0.3);
      color: var(--green);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .live-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse-dot 2s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.25} }
    .header-meta {
      font-size: 10px;
      color: var(--muted);
      text-align: right;
      letter-spacing: 0.04em;
      white-space: nowrap;
    }
    .header-meta strong { color: var(--text); }

    /* ── Main layout ── */
    main {
      max-width: 1440px;
      margin: 0 auto;
      padding: 20px 24px;
    }

    /* ── Stat Cards ── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-top: 2px solid var(--border);
      padding: 14px 16px;
    }
    .stat-label {
      font-size: 9px;
      color: var(--amber);
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 22px;
      font-weight: bold;
      color: var(--white);
    }
    .stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .border-green { border-top-color: var(--green); }
    .border-red   { border-top-color: var(--red); }
    .col-green { color: var(--green) !important; }
    .col-red   { color: var(--red)   !important; }
    .col-muted { color: var(--muted) !important; }
    .col-amber { color: var(--amber) !important; }

    /* ── Two-column ── */
    .main-grid {
      display: grid;
      grid-template-columns: 65fr 35fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    /* ── Panel ── */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
    }
    .panel-header {
      border-bottom: 1px solid var(--border);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-title {
      font-size: 10px;
      color: var(--amber);
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }
    .panel-body { padding: 16px; }

    /* ── Charts ── */
    .chart-wrap { position: relative; }
    .chart-sub-label {
      font-size: 9px;
      color: var(--amber);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 6px;
      opacity: 0.7;
    }
    .chart-divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    /* ── Run Panel ── */
    .run-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 7px;
      font-size: 11px;
    }
    .run-meta-label { color: var(--muted); }
    .run-meta-value { color: var(--text); font-weight: bold; }
    .conf-badge {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 2px;
      font-size: 10px;
      font-weight: bold;
    }
    .conf-high { background: rgba(0,230,118,0.15); color: var(--green); }
    .conf-med  { background: rgba(240,165,0,0.15);  color: var(--amber); }
    .conf-low  { background: rgba(255,68,68,0.15);  color: var(--red); }
    .summary-text {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.6;
      margin: 12px 0;
      border-left: 2px solid var(--border);
      padding-left: 8px;
    }
    .picks-list { display: flex; flex-direction: column; gap: 4px; }
    .pick-row {
      display: grid;
      grid-template-columns: 56px 38px 1fr 58px;
      gap: 6px;
      align-items: center;
      padding: 5px 8px;
      border: 1px solid transparent;
      font-size: 11px;
    }
    .pick-row.executed { border-color: rgba(0,230,118,0.18); background: rgba(0,230,118,0.03); }
    .pick-row.skipped  { opacity: 0.45; }
    .pick-ticker { font-weight: bold; color: var(--white); }
    .pick-alloc  { color: var(--muted); }
    .pick-status {
      font-size: 9px;
      padding: 1px 5px;
      border-radius: 1px;
      text-align: center;
      letter-spacing: 0.04em;
    }
    .pick-status.exec { background: rgba(0,230,118,0.15); color: var(--green); }
    .pick-status.skip { background: rgba(136,136,136,0.12); color: var(--muted); }
    .pick-amount { text-align: right; color: var(--text); }

    /* ── Positions Table ── */
    .positions-panel { background: var(--panel); border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      font-size: 9px;
      color: var(--amber);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 10px 14px;
      text-align: right;
      border-bottom: 1px solid var(--border);
      font-weight: normal;
    }
    thead th:first-child { text-align: left; }
    tbody tr { border-bottom: 1px solid rgba(42,42,42,0.7); transition: background 0.1s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(240,165,0,0.04); border-left: 2px solid var(--amber); }
    tbody td { padding: 10px 14px; font-size: 12px; text-align: right; color: var(--text); }
    tbody td:first-child { text-align: left; }
    .alloc-bar-wrap { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
    .alloc-bar { height: 3px; background: var(--amber); opacity: 0.45; border-radius: 1px; min-width: 2px; }

    /* ── Responsive ── */
    @media (max-width: 960px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .main-grid  { grid-template-columns: 1fr; }
    }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
  </style>
</head>
<body>

  <!-- Ticker Tape -->
  <div class="ticker-tape">
    <div class="ticker-tape-inner" id="ticker-tape-inner">
      <span>LOADING…</span>
    </div>
  </div>

  <!-- Header Bar -->
  <div class="header-bar">
    <div class="header-title">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f0a500" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
      </svg>
      INSIDER TRADING BOT
    </div>
    <div class="header-badges" id="header-badges">
      <span class="badge badge-live"><span class="live-dot"></span>LIVE</span>
    </div>
    <div class="header-meta">
      LAST SYNC<br>
      <strong id="last-updated">—</strong>
    </div>
  </div>

  <main>

    <!-- Stat Cards -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-label">Total Invested</div>
        <div class="stat-value" id="stat-invested">—</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current Value</div>
        <div class="stat-value" id="stat-value">—</div>
      </div>
      <div class="stat-card" id="card-pnl-eur">
        <div class="stat-label">Net P&amp;L (€)</div>
        <div class="stat-value" id="stat-pnl-eur">—</div>
      </div>
      <div class="stat-card" id="card-pnl-pct">
        <div class="stat-label">Net P&amp;L (%)</div>
        <div class="stat-value" id="stat-pnl-pct">—</div>
        <div class="stat-sub" id="stat-pnl-sub"></div>
      </div>
    </div>

    <!-- Chart + Run Panel -->
    <div class="main-grid">

      <!-- Chart -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">RETURNS &amp; POSITIONS</span>
          <span id="chart-date-range" style="font-size:10px;color:var(--muted)">—</span>
        </div>
        <div class="panel-body">
          <div class="chart-wrap">
            <div id="chart-empty" style="display:none;padding:40px 0;text-align:center;color:var(--muted);font-size:12px;">
              No history data yet.
            </div>
            <div id="charts-content">
              <div class="chart-sub-label">P&amp;L % OVER TIME</div>
              <div style="position:relative;height:160px">
                <canvas id="chart-pnl-pct"></canvas>
              </div>
              <div class="chart-divider"></div>
              <div class="chart-sub-label">CURRENT POSITION RETURNS</div>
              <div style="position:relative" id="chart-positions-wrap">
                <canvas id="chart-positions"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Latest Run -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title" id="run-title">LATEST RUN</span>
          <span id="run-date" style="font-size:10px;color:var(--muted)">—</span>
        </div>
        <div class="panel-body" id="run-panel-body">
          <p style="color:var(--muted);font-size:11px">No runs yet.</p>
        </div>
      </div>

    </div>

    <!-- Positions Table -->
    <div class="positions-panel">
      <div class="panel-header">
        <span class="panel-title">OPEN POSITIONS</span>
        <span id="positions-count" style="font-size:10px;color:var(--muted)">— HOLDINGS</span>
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th style="text-align:left">TICKER</th>
              <th>QTY</th>
              <th>AVG BUY</th>
              <th>CURRENT</th>
              <th>INVESTED</th>
              <th>VALUE</th>
              <th>P&amp;L €</th>
              <th>P&amp;L %</th>
              <th>DAYS</th>
            </tr>
          </thead>
          <tbody id="positions-body">
            <tr><td colspan="9" style="text-align:center;padding:32px;color:var(--muted)">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
  // ── Ticker Cleanup ──────────────────────────────────────────────────────────
  function cleanTicker(t) {
    return (t || '').replace(/_US_EQ$|_EQ$/, '');
  }

  // ── Formatters ──────────────────────────────────────────────────────────────
  function fmtEur(v) {
    if (v == null || v === '') return '—';
    return '€' + Number(v).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  function fmtPct(v) {
    if (v == null) return '—';
    const n = Number(v);
    return (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
  }
  function pnlCls(v)   { return Number(v) > 0 ? 'col-green' : Number(v) < 0 ? 'col-red' : 'col-muted'; }
  function pnlArrow(v) { return Number(v) > 0 ? '▲' : Number(v) < 0 ? '▼' : ''; }
  function confCls(v)  { return v >= 70 ? 'conf-high' : v >= 45 ? 'conf-med' : 'conf-low'; }

  // ── Ticker Tape ─────────────────────────────────────────────────────────────
  function renderTickerTape(positions) {
    const inner = document.getElementById('ticker-tape-inner');
    if (!positions || !positions.length) {
      inner.innerHTML = '<span>NO OPEN POSITIONS</span>';
      return;
    }
    const items = positions.map(p => {
      const t   = cleanTicker(p.ticker);
      const pct = Number(p.pnl_pct || 0);
      const cls = pct > 0 ? 'tape-up' : pct < 0 ? 'tape-down' : '';
      const arr = pct > 0 ? '▲' : pct < 0 ? '▼' : '–';
      return `<span class="${cls}">${t}  ${fmtEur(p.current_value_eur)}  ${fmtPct(pct)} ${arr}</span>`;
    });
    // Duplicate for seamless loop
    inner.innerHTML = [...items, ...items].join('');
    inner.style.animationDuration = Math.max(20, positions.length * 6) + 's';
  }

  // ── Stats ───────────────────────────────────────────────────────────────────
  function renderStats(p) {
    const inv   = Number(p.total_invested_eur   || 0);
    const val   = Number(p.total_value_eur       || 0);
    const pEur  = Number(p.unrealized_pnl_eur   || 0);
    const pPct  = Number(p.unrealized_pnl_pct   || 0);

    document.getElementById('stat-invested').textContent = fmtEur(inv);
    document.getElementById('stat-value').textContent    = fmtEur(val);

    const pEurEl = document.getElementById('stat-pnl-eur');
    pEurEl.textContent = fmtEur(pEur);
    pEurEl.className   = 'stat-value ' + pnlCls(pEur);

    const pPctEl = document.getElementById('stat-pnl-pct');
    pPctEl.textContent = fmtPct(pPct);
    pPctEl.className   = 'stat-value ' + pnlCls(pPct);
    document.getElementById('stat-pnl-sub').textContent = pnlArrow(pEur);

    document.getElementById('card-pnl-eur').className =
      'stat-card ' + (pEur > 0 ? 'border-green' : pEur < 0 ? 'border-red' : '');
    document.getElementById('card-pnl-pct').className =
      'stat-card ' + (pPct > 0 ? 'border-green' : pPct < 0 ? 'border-red' : '');
  }

  // ── Charts ───────────────────────────────────────────────────────────────────
  let _chartPnl = null;
  let _chartPos = null;

  const _chartDefaults = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1a1a1a',
        borderColor: '#333',
        borderWidth: 1,
        titleColor: '#f0a500',
        bodyColor: '#aaa',
      },
    },
  };

  function _splitFillPlugin() {
    // Draws green fill above zero and red fill below zero on a line chart
    return {
      id: 'splitFill',
      beforeDatasetsDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        if (!chartArea) return;
        const y0 = scales.y.getPixelForValue(0);
        const top = chartArea.top;
        const bot = chartArea.bottom;

        // Green zone (above zero)
        const greenGrad = ctx.createLinearGradient(0, top, 0, y0);
        greenGrad.addColorStop(0, 'rgba(0,230,118,0.25)');
        greenGrad.addColorStop(1, 'rgba(0,230,118,0.04)');

        // Red zone (below zero)
        const redGrad = ctx.createLinearGradient(0, y0, 0, bot);
        redGrad.addColorStop(0, 'rgba(255,68,68,0.04)');
        redGrad.addColorStop(1, 'rgba(255,68,68,0.22)');

        ctx.save();
        ctx.fillStyle = greenGrad;
        ctx.fillRect(chartArea.left, top, chartArea.width, Math.max(0, y0 - top));
        ctx.fillStyle = redGrad;
        ctx.fillRect(chartArea.left, y0, chartArea.width, Math.max(0, bot - y0));
        ctx.restore();
      },
    };
  }

  function renderCharts(history, positions) {
    const emptyEl      = document.getElementById('chart-empty');
    const chartsEl     = document.getElementById('charts-content');

    if (!history || !history.length) {
      emptyEl.style.display = 'block';
      chartsEl.style.display = 'none';
      return;
    }
    emptyEl.style.display = 'none';
    chartsEl.style.display = 'block';

    // Date range label
    const labels = history.map(h => h.date);
    if (labels.length > 1) {
      document.getElementById('chart-date-range').textContent =
        labels[0] + ' → ' + labels[labels.length - 1];
    }

    // ── Top chart: P&L % over time ──────────────────────────────────────────
    const pnlPcts = history.map(h =>
      h.total_invested_eur > 0
        ? parseFloat(((h.unrealized_pnl_eur / h.total_invested_eur) * 100).toFixed(2))
        : 0
    );

    if (_chartPnl) _chartPnl.destroy();
    _chartPnl = new Chart(
      document.getElementById('chart-pnl-pct').getContext('2d'),
      {
        type: 'line',
        plugins: [_splitFillPlugin()],
        data: {
          labels,
          datasets: [{
            data: pnlPcts,
            borderColor: ctx => {
              // Amber when positive overall, red when negative
              const last = pnlPcts[pnlPcts.length - 1] || 0;
              return last >= 0 ? '#f0a500' : '#ff4444';
            },
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointRadius: pnlPcts.length <= 14 ? 3 : 0,
            pointBackgroundColor: '#f0a500',
            segment: {
              borderColor: ctx =>
                ctx.p1.parsed.y >= 0 ? '#f0a500' : '#ff4444',
            },
          }],
        },
        options: {
          ..._chartDefaults,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            ..._chartDefaults.plugins,
            tooltip: {
              ..._chartDefaults.plugins.tooltip,
              callbacks: {
                label: ctx => ' Return: ' + (ctx.raw >= 0 ? '+' : '') + ctx.raw.toFixed(2) + '%',
              },
            },
          },
          scales: {
            x: {
              ticks: { color: '#555', font: { size: 9, family: 'Courier New' }, maxRotation: 30 },
              grid:  { color: 'rgba(240,165,0,0.05)' },
            },
            y: {
              ticks: {
                color: '#555',
                font: { size: 9, family: 'Courier New' },
                callback: v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%',
              },
              grid: { color: 'rgba(240,165,0,0.07)' },
            },
          },
        },
      }
    );

    // ── Bottom chart: current position P&L % ────────────────────────────────
    if (!positions || !positions.length) return;

    const sorted   = [...positions].sort((a, b) => b.pnl_pct - a.pnl_pct);
    const posLabels = sorted.map(p => cleanTicker(p.ticker));
    const posVals   = sorted.map(p => Number(p.pnl_pct || 0));
    const posColors = posVals.map(v =>
      v >= 0 ? 'rgba(0,230,118,0.7)' : 'rgba(255,68,68,0.7)'
    );
    const posBorder = posVals.map(v =>
      v >= 0 ? '#00e676' : '#ff4444'
    );

    // Dynamically size the canvas wrapper based on bar count
    document.getElementById('chart-positions-wrap').style.height =
      Math.max(80, sorted.length * 30) + 'px';

    if (_chartPos) _chartPos.destroy();
    _chartPos = new Chart(
      document.getElementById('chart-positions').getContext('2d'),
      {
        type: 'bar',
        data: {
          labels: posLabels,
          datasets: [{
            data: posVals,
            backgroundColor: posColors,
            borderColor: posBorder,
            borderWidth: 1,
            borderRadius: 2,
          }],
        },
        options: {
          ..._chartDefaults,
          indexAxis: 'y',
          interaction: { mode: 'index', intersect: false },
          plugins: {
            ..._chartDefaults.plugins,
            tooltip: {
              ..._chartDefaults.plugins.tooltip,
              callbacks: {
                label: ctx => ' ' + (ctx.raw >= 0 ? '+' : '') + ctx.raw.toFixed(2) + '%',
              },
            },
          },
          scales: {
            x: {
              ticks: {
                color: '#555',
                font: { size: 9, family: 'Courier New' },
                callback: v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%',
              },
              grid: { color: 'rgba(240,165,0,0.05)' },
            },
            y: {
              ticks: { color: '#d4d4d4', font: { size: 10, family: 'Courier New', weight: 'bold' } },
              grid: { display: false },
            },
          },
        },
      }
    );
  }

  // ── Latest Run Panel ─────────────────────────────────────────────────────────
  function renderRunPanel(runs) {
    if (!runs || !runs.length) return;
    const run = runs[runs.length - 1];

    document.getElementById('run-title').textContent = 'RUN #' + (run.run_number || runs.length);
    document.getElementById('run-date').textContent  = run.date || '';

    const conf     = run.confidence || 0;
    const picks    = run.picks || [];
    const summary  = (run.market_summary || '').substring(0, 210);
    const hasMore  = (run.market_summary || '').length > 210;

    const picksHtml = picks.map(p => {
      const cls    = p.executed ? 'executed' : 'skipped';
      const stCls  = p.executed ? 'exec' : 'skip';
      const stLbl  = p.executed ? '✓ EXEC' : 'SKIP';
      return `<div class="pick-row ${cls}">
        <span class="pick-ticker">${cleanTicker(p.ticker)}</span>
        <span class="pick-alloc">${p.allocation_pct}%</span>
        <span class="pick-status ${stCls}">${stLbl}</span>
        <span class="pick-amount">${p.executed ? fmtEur(p.amount_eur) : '—'}</span>
      </div>`;
    }).join('');

    document.getElementById('run-panel-body').innerHTML = `
      <div>
        <div class="run-meta-row">
          <span class="run-meta-label">INSIDER SIGNALS</span>
          <span class="run-meta-value">${run.insider_count || 0}</span>
        </div>
        <div class="run-meta-row">
          <span class="run-meta-label">CONFIDENCE</span>
          <span class="conf-badge ${confCls(conf)}">${conf}%</span>
        </div>
        <div class="run-meta-row">
          <span class="run-meta-label">DEPLOYED</span>
          <span class="run-meta-value">${fmtEur(run.total_spent_eur)}</span>
        </div>
      </div>
      ${summary ? `<div class="summary-text">${summary}${hasMore ? '…' : ''}</div>` : ''}
      <div class="picks-list">
        ${picksHtml || '<p style="color:var(--muted);font-size:11px">No picks.</p>'}
      </div>
    `;

    // Update header badges
    document.getElementById('header-badges').innerHTML = `
      <span class="badge badge-live"><span class="live-dot"></span>LIVE</span>
      <span class="badge">SIGNALS: ${run.insider_count || 0}</span>
      <span class="badge conf-badge ${confCls(conf)}">CONFIDENCE: ${conf}%</span>
    `;
  }

  // ── Positions Table ──────────────────────────────────────────────────────────
  function renderPositions(positions, totalValue) {
    const tbody   = document.getElementById('positions-body');
    const countEl = document.getElementById('positions-count');

    const sorted = (positions || []).slice().sort((a, b) => b.current_value_eur - a.current_value_eur);
    countEl.textContent = sorted.length + (sorted.length !== 1 ? ' HOLDINGS' : ' HOLDING');

    if (!sorted.length) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--muted)">No open positions.</td></tr>';
      return;
    }

    tbody.innerHTML = sorted.map(pos => {
      const t        = cleanTicker(pos.ticker);
      const pCls     = pnlCls(pos.pnl_pct);
      const arr      = pnlArrow(pos.pnl_pct);
      const allocPct = totalValue > 0 ? (pos.current_value_eur / totalValue * 100) : 0;
      const barW     = Math.max(2, Math.min(72, allocPct * 0.85));

      return `<tr>
        <td style="font-weight:bold;color:var(--white)">${t}</td>
        <td>${Number(pos.quantity || 0).toFixed(3)}</td>
        <td>${fmtEur(pos.avg_buy_price)}</td>
        <td>${fmtEur(pos.current_price)}</td>
        <td style="color:var(--muted)">${fmtEur(pos.invested_eur)}</td>
        <td>
          <div class="alloc-bar-wrap">
            <div class="alloc-bar" style="width:${barW}px"></div>
            ${fmtEur(pos.current_value_eur)}
          </div>
        </td>
        <td class="${pCls}">${fmtEur(pos.pnl_eur)}</td>
        <td class="${pCls}">${arr ? arr + ' ' : ''}${fmtPct(pos.pnl_pct)}</td>
        <td style="color:var(--muted)">${pos.days_held ?? '—'}</td>
      </tr>`;
    }).join('');
  }

  // ── Main Load ────────────────────────────────────────────────────────────────
  async function loadData() {
    let data;
    try {
      const res = await fetch('data.json?_=' + Date.now());
      if (!res.ok) throw new Error('HTTP ' + res.status);
      data = await res.json();
    } catch (err) {
      document.getElementById('last-updated').textContent = 'Error loading data';
      document.getElementById('positions-body').innerHTML =
        `<tr><td colspan="9" style="text-align:center;padding:32px;color:var(--red)">
          Could not load data.json — ${err.message}
        </td></tr>`;
      return;
    }

    if (data.last_updated) {
      document.getElementById('last-updated').textContent =
        data.last_updated.replace('T', ' ') + ' UTC';
    }

    const p = data.portfolio || {};
    renderTickerTape(p.positions || []);
    renderStats(p);
    renderCharts(data.portfolio_history || [], p.positions || []);
    renderRunPanel(data.runs || []);
    renderPositions(p.positions || [], p.total_value_eur || 0);
  }

  loadData();
  </script>
</body>
</html>
